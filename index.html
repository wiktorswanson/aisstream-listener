<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live AIS Map â€“ With Sidebar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 100%; margin-left: 300px; }
    header {
      position: fixed; top: 0; left: 300px; right: 0;
      padding: 10px; background: #333; color: white;
      z-index: 1001; text-align: center;
    }
    #sidebar {
      width: 300px;
      height: 100%;
      position: fixed;
      left: 0;
      top: 0;
      background: #f8f9fa;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      z-index: 1002;
    }
    #tabs {
      display: flex;
      justify-content: space-around;
      background: #e9ecef;
    }
    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom: 2px solid #007bff;
      font-weight: bold;
    }
    .tab-content {
      display: none;
      padding: 10px;
    }
    .tab-content.active {
      display: block;
    }
    .ship-list-item {
      padding: 6px;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="tabs">
      <div class="tab active" onclick="switchTab('list')">Ship List</div>
      <div class="tab" onclick="switchTab('search')">Search</div>
    </div>
    <div id="tab-list" class="tab-content active">
      <div id="ship-list">No ships yet...</div>
    </div>
    <div id="tab-search" class="tab-content">
      <iframe src="https://www.vesselfinder.com" width="100%" height="600" style="border:none;"></iframe>
    </div>
  </div>

  <header>Live AIS Map</header>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([57.5, 15.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = {};
    const shipList = {};

    const shipListEl = document.getElementById("ship-list");
    const socket = new WebSocket("wss://aisstream-listener-qfgo.onrender.com/ws");

    socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      if (data.MessageType !== "PositionReport") return;

      const meta = data.MetaData;
      const lat = data.Position?.Lat || meta.latitude;
      const lon = data.Position?.Lon || meta.longitude;
      const mmsi = meta.MMSI;
      const name = meta.ShipName || "Unknown Ship";

      if (!lat || !lon) return;

      if (!markers[mmsi]) {
        markers[mmsi] = L.marker([lat, lon]).addTo(map)
          .bindPopup(`<b>${name}</b><br>MMSI: ${mmsi}`);
      } else {
        markers[mmsi].setLatLng([lat, lon]);
      }

      shipList[mmsi] = name;
      renderShipList();
    };

    function renderShipList() {
      const items = Object.entries(shipList).map(([mmsi, name]) => {
        return `<div class="ship-list-item"><b>${name}</b><br>MMSI: ${mmsi}</div>`;
      }).join('');
      shipListEl.innerHTML = items || 'No ships yet...';
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelector(`.tab:contains('${tab.charAt(0).toUpperCase() + tab.slice(1)}')`)?.classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // Polyfill for tab switching (because :contains isn't supported in querySelector)
    document.querySelectorAll('.tab').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.textContent.toLowerCase();
        switchTab(id);
      });
    });
  </script>
</body>
</html>
